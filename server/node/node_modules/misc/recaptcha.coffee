require "coffee-script"

settings        = require "settings"
http            = require "http"
querystring     = require "querystring"
recaptcha_keys  = require settings.security.recaptcha.key_path

exports.verify = (ip, challenge, response, callback) ->
  data = querystring.stringify {
    privatekey: recaptcha_keys.private_key
    remoteip: ip
    challenge
    response
  }

  http.request({
    host:   settings.security.recaptcha.endpoint.host
    path:   settings.security.recaptcha.endpoint.path
    method: "POST"
    headers: {
      "Content-Type":   "application/x-www-form-urlencoded"
      "Content-Length": data.length
    }
  }, (res) ->
    res.setEncoding "utf8"
    response = ""
    res.on("data", (chunk) ->
      response += chunk
    ).on("end", () ->
      response = response.split "\n"
      if String(response.shift()) != "true"
        callback? response.join("\n"), false
        return
      callback? null, true
    )
  ).on("error", (err) ->
    callback? err, false
  ).end(data)