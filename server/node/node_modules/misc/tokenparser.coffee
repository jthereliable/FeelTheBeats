require "coffee-script"

tokenizer =   require "misc/tokenizer"
mongo =       require "database/mongo"

NO_TOKEN = {
  uid: 0
  name: "Guest"
  cheater: false
  group: {
    gid: 0
    name: "n/a"
    position: "member"
  }
  access: {
    mod: 0
    charter: 0
    ban: 0
  }
}

exports = module.exports = (req, res, next) ->
  raw_token = req.get("Auth-Token") || req.body?.token || req.query?.token
  if !raw_token?
    res.locals.token = NO_TOKEN
    next()
    return

  if !tokenizer.validate raw_token
    res.json {
      err: "Invalid token provided"
    }
    return
  if !tokenizer.alive raw_token
    res.json {
      err: "Token has expired"
    }
    return

  id = raw_token.split("|",1)[0]|0
  mongo.collection("UserTokens").find {
    uid: id
  }, {
    _id: 0,
    token: 1
  }, (err, rows) ->
    if err
      res.json {
        err: "Database error"
      }
      return
    if rows.length == 0
      res.json {
        err: "Invalid token provided"
      }
    res.locals.token = tokenizer.parse raw_token, rows[0].token
    next()