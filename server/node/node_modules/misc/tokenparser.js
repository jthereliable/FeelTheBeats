var tokenizer		= require("misc/tokenizer"),
	async			= require("async"),
	mongo			= require("database/mongo");

var no_token = {
	"uid": 0,
	"name": "Guest",
	"cheater": false,
	"group": {
		"gid": 0,
		"name": "n/a",
		"position": "member"
	},
	"access": {
		"mod": 0,
		"charter": 0,
		"ban": 0
	}
};

module.exports = exports = function(req, res, next) {
	var raw_token = req.get("Auth-Token") || (req.body || {}).token || (req.query || {}).token;
	if(raw_token == null)
	{
		res.locals.token = no_token;
		next();
		return;
	}
	if(!tokenizer.validate(raw_token))
	{
		res.json({
			"err": "Invalid token provided."
		});
		return;
	}
	if(!tokenizer.alive(raw_token))
	{
		res.json({
			"err": "Token has expired."
		});
		return;
	}
	
	var id=raw_token.split("|",1)[0]|0;
	mongo.collection("UserTokens").find({
		"uid": id
	}, {
		"_id": 0,
		"token": 1
	}, function(err, rows) {
		if(err)
		{
			res.json({
				"err": "Database Error"
			});
			return;
		}
		if(rows.length == 0)
		{
			res.json({
				"err": "Invalid token provided."
			});
			return;
		}
		res.locals.token = tokenizer.parse(raw_token, rows[0].token);
		next();
	});
};