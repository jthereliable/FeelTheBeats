var tokenizer = 		require("misc/tokenizer");

var no_token = {
	"name": "Guest",
	"access": {
		"mod": 0,
		"charter": 0,
		"ban": 0
	}
};

module.exports = exports = function(req, res, next) {
	var raw_token = req.get("Auth-Token") || (req.body || {}).token || (req.query || {}).token;
	var token = no_token;
	if(raw_token != null)
	{
		token = tokenizer.parse(raw_token);
		if(token == null)
		{
			if(!tokenizer.validate(raw_token))
			{
				res.json({
					"err": "Invalid token provided."
				});
				return;
			} else {
				res.json({
					"err": "Token has expired."
				});
				return;
			}
		}
	}
	res.locals.token = token;
	
	next();
};